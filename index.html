<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D人生ゲーム</title>
  <style>
    body {
      margin: 0; min-height: 100vh; display: grid; place-items: center;
      background: linear-gradient(180deg, #e0f2ff, #c2e9ff);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      color: #0f172a; padding: 16px;
    }
    .app {
      width: min(820px, 100%); background: #fff; border: 1px solid rgba(15,23,42,.08);
      border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.12); padding: 16px;
    }
    h1 { text-align: center; margin: 4px 0 12px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    label { color: #475569; }
    input[type=text] { flex: 1; min-width: 220px; padding: 12px 14px; border: 1px solid #cbd5e1; border-radius: 10px; }
    .panel { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; margin: 10px 0; }
    .display { text-align: center; font-variant-numeric: tabular-nums; }
    .value { font-size: clamp(30px, 7vw, 54px); font-weight: 800; }
    .grid { display: grid; gap: 10px; grid-template-columns: repeat(2, minmax(0,1fr)); }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 16px;
           border: 1px solid #cbd5e1; border-radius: 10px; font-weight: 700; cursor: pointer; }
    .pos { background: #e7f9ee; color: #16a34a; }
    .neg { background: #fdecec; color: #dc2626; }
    .clear { background: #eef2f7; }
    .primary { background: #0ea5e9; color: #fff; border-color: #0284c7; }
    .sum { display: flex; justify-content: space-between; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: #fff; }
  </style>
</head>
<body>
  <main class="app">
    <h1>3D人生ゲーム</h1>

    <!-- チーム名 & 送信ボタン -->
    <section class="panel">
      <div class="row">
        <label for="team">チーム名：</label>
        <input id="team" type="text" placeholder="例：Aチーム" />
        <button class="btn primary" id="sendBtn">スプレッドシートへ送信</button>
      </div>
      <div id="toast" style="margin-top:6px;color:#334155"></div>
    </section>

    <!-- 学年タブ（単一表示：切替式）-->
    <nav class="row" style="justify-content:center">
      <button class="btn" data-year="1">1年生</button>
      <button class="btn" data-year="2">2年生</button>
      <button class="btn" data-year="3">3年生</button>
    </nav>

    <!-- 1年初期設定 -->
    <section class="panel" id="init-panel">
      <div class="row">
        <label for="initial">1年生の初期金額：</label>
        <input id="initial" type="text" inputmode="numeric" placeholder="例：10,000（カンマOK）" />
        <button class="btn" id="setBtn">設定</button>
      </div>
    </section>

    <!-- 現在の学年表示 & 操作ボタン（共通） -->
    <section class="panel">
      <div class="display">
        <div id="gradeLabel">現在：1年生</div>
        <div class="value" id="value">0円</div>
      </div>
      <div class="grid" style="margin-top:10px">
        <button class="btn pos" data-delta="1000">＋1,000円</button>
        <button class="btn neg" data-delta="-1000">−1,000円</button>
        <button class="btn pos" data-delta="10000">＋10,000円</button>
        <button class="btn neg" data-delta="-10000">−10,000円</button>
      </div>
      <div class="row" style="margin-top:10px;justify-content:center">
        <button class="btn clear" id="clearBtn">クリア（0円）</button>
      </div>
    </section>

    <!-- サマリー -->
    <section class="panel">
      <div class="sum"><span>1年生</span><strong id="sum1">0円</strong></div>
      <div class="sum"><span>2年生</span><strong id="sum2">0円</strong></div>
      <div class="sum"><span>3年生</span><strong id="sum3">0円</strong></div>
      <div class="sum" style="border-color:#0ea5e9"><span>最終合計</span><strong id="total">0円</strong></div>
    </section>
  </main>

  <script>
    // ====== ここに /exec を貼る（シートURLではありません） ======
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbyzonpmlVacrjm3PtNh6-wUX_9Q0Nhx_wKKkWh2XwvdWfSGZyl1hnx-7O9KaPfn_PwI/exec";

    // 金額管理
    const yenFmt = new Intl.NumberFormat('ja-JP');
    const toYen = n => `${yenFmt.format(n)}円`;
    const amounts = {1:0,2:0,3:0};
    let currentYear = 1;

    // 要素
    const teamInput = document.getElementById('team');
    const sendBtn = document.getElementById('sendBtn');
    const toast = document.getElementById('toast');
    const initPanel = document.getElementById('init-panel');
    const initialInput = document.getElementById('initial');
    const setBtn = document.getElementById('setBtn');
    const gradeLabel = document.getElementById('gradeLabel');
    const valueEl = document.getElementById('value');
    const clearBtn = document.getElementById('clearBtn');

    // 学年切替
    document.querySelectorAll('[data-year]').forEach(b=>{
      b.addEventListener('click',()=>{
        currentYear = Number(b.dataset.year);
        initPanel.style.display = currentYear === 1 ? 'block' : 'none';
        render();
      });
    });

    // 1年生 初期金額設定（カンマ/全角対応）
    function parseInput(str){
      if(!str) return 0;
      const normalized = str.toString()
        .replace(/[\u3000\s]/g,'')
        .replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0)-0xFEE0))
        .replace(/,/g,'');
      const n = Number(normalized);
      return Number.isFinite(n) ? Math.trunc(n) : 0;
    }
    setBtn.addEventListener('click', ()=>{
      amounts[1] = parseInput(initialInput.value);
      render();
    });

    // 増減
    document.querySelectorAll('[data-delta]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const d = Number(btn.dataset.delta)||0;
        amounts[currentYear] = Math.trunc((amounts[currentYear]||0)+d);
        render();
      });
    });

    // クリア（現在の学年のみ）
    clearBtn.addEventListener('click',()=>{ amounts[currentYear]=0; render(); });

    // 画面表示
    function render(){
      gradeLabel.textContent = `現在：${currentYear}年生`;
      valueEl.textContent = toYen(amounts[currentYear]);
      document.getElementById('sum1').textContent = toYen(amounts[1]);
      document.getElementById('sum2').textContent = toYen(amounts[2]);
      document.getElementById('sum3').textContent = toYen(amounts[3]);
      document.getElementById('total').textContent = toYen(amounts[1]+amounts[2]+amounts[3]);
    }
    render();

    // ====== 送信（CORSに強いフォームPOST：隠しiframe） ======
    const hiddenFrameName = 'sheet_sink_iframe';
    let hiddenFrame = document.getElementById(hiddenFrameName);
    if(!hiddenFrame){
      hiddenFrame = document.createElement('iframe');
      hiddenFrame.name = hiddenFrameName;
      hiddenFrame.id = hiddenFrameName;
      hiddenFrame.style.display = 'none';
      document.body.appendChild(hiddenFrame);
    }

    function sendToSheet(){
      const team = (teamInput.value||'').trim();
      if(!team){ toast.textContent = 'チーム名を入力してください'; return; }
      if(!SHEETS_URL){ toast.textContent = 'SHEETS_URL が未設定です'; return; }

      const payload = {
        team,
        year1: amounts[1],
        year2: amounts[2],
        year3: amounts[3],
        total: amounts[1]+amounts[2]+amounts[3]
      };

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = SHEETS_URL;
      form.target = hiddenFrameName;
      form.style.display = 'none';
      form.acceptCharset = 'UTF-8';
      form.enctype = 'application/x-www-form-urlencoded';

      // team と team_name の両方を送る（どちらでも受け取れるように）
      const entries = Object.entries(payload).concat([
        ['team_name', payload.team],
        ['_ts', Date.now().toString()] // キャッシュ対策
      ]);
      entries.forEach(([k,v])=>{
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = String(v ?? '');
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
      setTimeout(()=>form.remove(), 3000);
      toast.textContent = '送信しました。シートを確認してください。';
    }

    sendBtn.addEventListener('click', sendToSheet);
  </script>
</body>
</html>
